# yaml-language-server: $schema=schemas/recipe.json

vibversion: 1.0.0
id: vesper-vanilla-desktop
name: Vesper's Vanilla Desktop

stages:
  - id: build
    singlelayer: false

    labels:
      maintainer: MaurÃ­cio Braz

    args:
      DEBIAN_FRONTEND: noninteractive

    runs:
      commands:
        - mkdir -p /etc/apt/keyrings
        - mkdir -p /etc/apt/sources.list.d

        - echo 'APT::Install-Recommends "1";' > /etc/apt/apt.conf.d/01norecommends

        - curl -fsSL https://keyserver.ubuntu.com/pks/lookup?op=get&search=0x6E4D6A1C | gpg --dearmor -o /etc/apt/keyrings/tmux.gpg
        - curl -fsSL https://keyserver.ubuntu.com/pks/lookup?op=get&search=0x8A8F901A | gpg --dearmor -o /etc/apt/keyrings/ripgrep.gpg
        - curl -fsSL https://keyserver.ubuntu.com/pks/lookup?op=get&search=0x73F7A150FE08CC17 | gpg --dearmor -o /etc/apt/keyrings/howdy.gpg

        - echo "deb [signed-by=/etc/apt/keyrings/tmux.gpg] http://ppa.launchpad.net/tmux-pppa/tmux/ubuntu jammy main" > /etc/apt/sources.list.d/tmux-ppa.list
        - echo "deb [signed-by=/etc/apt/keyrings/howdy.gpg] http://ppa.launchpad.net/boltgolt/howdy/ubuntu jammy main" > /etc/apt/sources.list.d/howdy-ppa.list
        - echo "deb [signed-by=/etc/apt/keyrings/ripgrep.gpg] http://ppa.launchpad.net/x4121/ripgrep/ubuntu jammy main" > /etc/apt/sources.list.d/ripgrep-ppa.list

    base: ghcr.io/vanilla-os/desktop:main

    modules:
      - name: init
        type: shell
        commands:
          - lpkg --unlock
          - apt-get update
          - apt-get upgrade -y

      # Custom Actions
      # Custom Actions

      - name: apt
        type: apt
        sources:
          - path: modules/apt.inst
        options:
          fix_broken: true
          fix_missing: true
          no_recommends: true
          install_suggests: true

      - name: docker
        type: includes
        includes:
          - modules/docker.yml

      - name: one-password
        type: includes
        includes:
          - modules/one-password.yml

      - name: flatpak
        type: flatpak
        system:
          reponame: flathub
          install:
            - comcom.obsproject.Studio
            - com.github.wwmm.easyeffects
            - com.obsproject.Studio.Plugin.DroidCam
          repourl: https://flathub.org/repo/flathub.flatpakrepo

      - name: presets
        type: shell
        commands:
          - EASY_EFFECTS_FOLDER=/var/lib/flatpak/app/com.github.wwmm.easyeffects/current/active/files/easy-effects/
          - mkdir -p $EASY_EFFECTS_FOLDER/presets && cp -r /usr/share/presets/* $EASY_EFFECTS_FOLDER/
          - chmod -R 755 $EASY_EFFECTS_FOLDER

      # Custom Actions
      # Custom Actions

      - name: set-image-name
        type: shell
        commands:
          - IMAGE_NAME="$(cat /image-info/image-name)"
          - echo custom image name "$IMAGE_NAME"
          - IMAGE_NAME_ESCAPED="$(echo $IMAGE_NAME | sed 's/\//\\\//g')"
          - sed -i "s/changed_automatically_by_vib/$IMAGE_NAME_ESCAPED/g" /usr/share/abroot/abroot.json
          - rm -rf /image-info

      - name: pre-cleanup
        type: shell
        commands:
          - apt-get autoremove -y
          - apt-get clean
          - lpkg --lock

      - name: fsguard
        type: fsguard

        GenerateKey: true
        CustomFsGuard: false

        FilelistPaths: ["/usr/bin"]
        FsGuardLocation: "/usr/sbin/FsGuard"

        modules:
          - name: remove-prev-fsguard
            type: shell
            commands:
              - rm -rf /FsGuard
              - rm -f ./minisign.pub ./minisign.key
              - chmod +x /usr/sbin/init

      - name: cleanup
        type: shell
        commands:
          - rm -rf /tmp/*
          - rm -rf /sources
          - rm -rf /var/tmp/*
